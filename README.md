# Инструкция по репликации в Postgre

### Перед прочтением инструкции советую ознамоиться со [статьёй](https://habr.com/ru/articles/514500/) с целью понимания, что такое репликация

## Логическая репликация
Шаги установки:
1. Установка логического декодирования. Переходим по пути (для собственного удобства опишу полный путь для MacOS): ```/Library/PostgreSQL/17/data```. Открываем файл ```postgresql.conf``` и вписываем:
    ```
    wal_level = logical
    max_replication_slots = 5
    max_wal_senders = 10
    ```
  * Установка wal_level в значение logical позволяет WAL записывать информацию, необходимую для логического декодирования.
  * Убедитесь, что значение параметра max_replication_slots равно или больше количества коннекторов PostgreSQL, использующих WAL, и прибавьте к этому количество других слотов репликации, используемых вашей базой данных.
  * Убедитесь, что параметр max_wal_senders, определяющий максимальное количество одновременных соединений с WAL, как минимум вдвое превышает количество логических слотов репликации. Например, если ваша база данных использует в общей сложности 5 слотов репликации, значение параметра max_wal_senders должно быть 10 или больше.

2. Перезапустим сервис postgresql
   Команды для перезапуска postgresql для маководов, если она была установлена через ```.dmg``` с официального сайта:  
   ```sudo launchctl list | grep postgres``` - просмотр сервисов postgres  
   ```sudo launchctl start/stop postgresql-17``` - старт/остановка сервиса
  
3. Настроить логическую репликацию с помощью подключаемого модуля ```test_decoding```:<br/>
   Создайте слот логической репликации для базы данных, которую вы хотите синхронизировать, выполнив следующую команду:<br/>
    
   ``` SELECT pg_create_logical_replication_slot('replication_slot', 'test_decoding'); ```<br/>
   
   Чтобы убедиться в том, что слот был успешно создан, выполните следующую команду:<br/>
   
   ```SELECT slot_name, plugin, slot_type, database, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;```

5. Cоздайте публикацию для всех ваших таблиц или только для тех, что вам нужны. Если вы зададите конкретные таблицы, вы сможете добавить или удалить их из публикации позже.
  Все таблицы:  
   ```CREATE PUBLICATION pub FOR ALL TABLES;```
   Для определённых таблиц:
   ```CREATE PUBLICATION pub FOR TABLE table1, table2, table3;```
   По желанию вы можете выбрать, какие операции включить в публикацию. Например, следующая публикация включает для первой таблицы (table1) только операции INSERT и UPDATE.
   ```CREATE PUBLICATION insert_update_only_pub FOR TABLE table1 WITH (publish = 'INSERT, UPDATE');```

6. Убедитесь, что выбранные вами таблицы есть в публикации.
   ```SELECT * FROM pg_publication_tables WHERE pubname='pub';```
   OUTPUT:
   ```
   pubname | schemaname | tablename
    ---------+------------+-----------
    pub     | public     | table1
    pub     | public     | table2
    pub     | public     | table3
    (3 rows)
    ```
   С этого момента наша публикация ```pub` будет отслеживать изменения всех таблиц в базе данных ```psql-stream```.


